<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.emr.slgi.treatment.TreatmentDAO">

  <insert id="insertTreatment"  parameterType="com.emr.slgi.treatment.Treatment" >
    INSERT INTO TB_TREATMENT(uuid)
    VALUES (#{uuid})
  </insert>
  
  <select id ="getHistory" parameterType="map" resultType="com.emr.slgi.treatment.Treatment">
  	select t.*
	from tb_treatment t
	join tb_reception r on t.uuid = r.uuid
	where  r.doctor_uuid = #{doctorUuid} and r.patient_uuid = #{patientUuid}
	order by t.treat_date desc
	limit #{start}, #{size}
  </select>
  
  
  <select id="getHistoryCount" parameterType="map" resultType="int">
	  SELECT COUNT(*)
	  FROM TB_TREATMENT T 
	  JOIN TB_RECEPTION R ON T.uuid = R.uuid
	  WHERE R.doctor_uuid = #{doctorUuid}
    	AND R.patient_uuid = #{patientUuid}
</select>
  
  <select id ="selectTreatment" resultType="com.emr.slgi.treatment.Treatment">
  	select *
  	from tb_treatment t
  	where t.id =#{id}
  	
  </select>
  
 
  <insert id="updateTreatment"  parameterType="com.emr.slgi.treatment.Treatment"  >
    update tb_treatment
    	set treat_content = #{treatContent},
    		write_yn = 'Y'
	 where id = #{id}
  </insert>
  
  
  <insert id ="getDocument">
  SELECT p.code as prescription_code, p.volume, m.name AS medicine_name, t.treat_date, r.name,r.rrn,r.patient_uuid,me.name as doctor_name,di.name,di.code as disease_code
	FROM tb_prescription p
	JOIN tb_medicine m ON p.code = m.code
	JOIN tb_treatment t ON p.treatment_id = t.id
	JOIN tb_reception r ON t.uuid = r.uuid
	join tb_member me on me.uuid = r.doctor_uuid
	join tb_diagnosis d on d.treatment_id = t.id 
	join tb_disease di on di.id = d.id
	where p.treatment_id = #{treatmentId}
  </insert>
</mapper>