<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="com.emr.slgi.read.ChatReadDAO">
  
  <insert id = "readtime">
  INSERT INTO tb_chat_read (room_id, message_id,uuid, read_time)
  VALUES (#{roomId}, #{messageId},#{uuid}, NOW() )
  ON DUPLICATE KEY UPDATE read_time = NOW()
  
  </insert>
  
  <select id="selectMessages" resultType="com.emr.slgi.read.ChatRead">
  SELECT m.room_id, m.message_id, #{uuid} as uuid
	FROM tb_chat_message m
	WHERE m.room_id = #{roomId}
  	AND (
    m.create_date > (
    	SELECT j.out_time
    	FROM tb_chat_join j
      	WHERE j.room_id = #{roomId}
        	AND j.uuid = #{uuid}
        	AND j.out_time IS NOT NULL
    )
    OR EXISTS (
      SELECT 1
      FROM tb_chat_join j
      WHERE j.room_id = #{roomId}
        AND j.uuid = #{uuid}
        AND j.join_time IS NOT NULL
        AND j.out_time IS NULL
    )
  )
  
  AND m.uuid != #{uuid}

  	</select>
 
 
 <select id="getList" resultType="com.emr.slgi.read.ChatAlarmDTO" >


SELECT
  cr.room_id as roomId,                           
  cr.room_name as roomName, 
  (
    SELECT m1.content
    FROM tb_chat_message m1
    WHERE m1.room_id = cr.room_id
      AND m1.create_date > (
        SELECT IFNULL(MAX(r.read_time), '1970-01-01 00:00:00')
        FROM tb_chat_read r
        WHERE r.room_id = cr.room_id
          AND r.uuid = #{uuid}
      )
      AND m1.uuid != #{uuid}
    ORDER BY m1.create_date DESC
    LIMIT 1
  ) AS content,


  COUNT(m.message_id) AS alarmCount

FROM tb_chat_message m
JOIN tb_chat_room cr ON m.room_id = cr.room_id
JOIN tb_chat_join j ON j.room_id = m.room_id

WHERE j.uuid =#{uuid}
  AND m.uuid != #{uuid}
  AND m.create_date > (
    SELECT IFNULL(MAX(r.read_time), '1970-01-01 00:00:00')
    FROM tb_chat_read r
    WHERE r.room_id = m.room_id
      AND r.uuid = #{uuid}
  )

GROUP BY cr.room_id, cr.room_name;

 
 
 </select>
 
 
 
</mapper>



